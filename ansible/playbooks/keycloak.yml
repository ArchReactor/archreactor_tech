---

- hosts: keycloak_server

  vars:

    KEYCLOAK_PORT: 9909
    KEYCLOAK_HOST: "users.archreactor.net"

    nginx_redirects:
      - from: "{{ KEYCLOAK_HOST }}"
        to: "127.0.0.1:{{ KEYCLOAK_PORT }}"

  roles:
    - role: nginx

  tasks:

    - name: Generate redirect config
      template:
        src: nginx_redirect.j2
        dest: /etc/nginx/sites-enabled/users.archreactor.net.conf
        owner: www-data
        group: www-data
      notify: restart nginx
      become: yes

    - name: Install Keycloak
      docker_container:
        image: quay.io/keycloak/keycloak
        name: keycloak
        env:
          KEYCLOAK_USER: "admin"
          KEYCLOAK_PASSWORD: "admin"
          DB_VENDOR: "h2"
        ports:
          - "{{ KEYCLOAK_PORT }}:8080"
        restart_policy: "unless-stopped"
    
    - name: Wait for keycloak to start
      wait_for:
        host: "{{ KEYCLOAK_HOST }}"
        port: "{{ KEYCLOAK_PORT }}"
        timeout: 15